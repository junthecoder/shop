{% include 'pre_body.html.twig' with {'title': 'ユーザ登録'} %}
  <div class="container p-5" style="max-width: 480px;">
    {% if register %}
      <p>ユーザ登録を完了しました。</p>
      <a href="/">トップページへ</a>
    {% else %}
      <form class="container p-5 needs-validation" action="register.php" method="post" id="registration-form" novalidate>
        <div class="row mb-4">
          <h3>ユーザ登録</h3>
        </div>
        <div class="row mb-3">
          <label for="name-input" class="form-label">氏名</label>
          {% if check %}
            <p>{{ post.name }}</p>
            <input type="hidden" name="name" value="{{ post.name }}">
          {% else %}
            <input type="text" name="name" class="form-control" id="name-input" placeholder="山田 太郎" required>
            <div class="invalid-feedback d-block" id="name-feedback"></div>
          {% endif %}
        </div>
        <div class="row mb-3">
          <label for="email-input" class="form-label">メールアドレス</label>
          {% if check %}
            <p>{{ post.email }}</p>
            <input type="hidden" name="email" value="{{ post.email }}">
          {% else %}
            <input type="email" name="email" class="form-control" id="email-input" placeholder="name@example.com" required>
            <div class="invalid-feedback d-block" id="email-feedback"></div>
          {% endif %}
        </div>
        <div class="row mb-3">
          <label for="password-input" class="form-label">パスワード</label>
          {% if check %}
            <p>****</p>
            <input type="hidden" name="password" value="{{ post.password }}">
          {% else %}
            <input type="password" name="password" class="form-control" id="password-input" placeholder="8文字以上" required>
            <div class="invalid-feedback d-block" id="password-feedback"></div>
          {% endif %}
        </div>
      {% if check %}
      {% else %}
          <div class="row mb-3">
            <label for="password-check-input" class="form-label">もう一度パスワードを入力してください</label>
            <input type="password" name="password-check" class="form-control" id="password-check-input" required>
            <div class="invalid-feedback d-block" id="password-check-feedback"></div>
          </div>
      {% endif %}
        <div class="row my-4">
          {% if check %}
            <input type="hidden" name="register" value="1">
            <input type="submit" class="btn btn-primary" value="登録する">
          {% else %}
            <input type="hidden" name="check" value="1">
            <input type="submit" class="btn btn-primary" name="submit" value="次に進む">
          {% endif %}
        </div>
      </form>
    {% endif %}
  </div>

  <script>
    'use strict';

    function validateName() {
      let name = $('#name-input').val();

      let errors = [];
      if (!/\S/.test(name)) {
        errors.push('名前を入力してください');
      }
      $('#name-feedback').html(errors.join('<br>'));

      return errors.length === 0;
    }

    function validateEmail() {
      let email = $('#email-input').val();

      let errors = [];
      if (!/^\S+@\S+$/.test(email)) {
        errors.push('メールアドレスを入力してください');
      }

      $.ajax({
        type: 'POST',
        url: 'validation.php',
        async: false,
        data: { email }
      })
      .done(data => {
        errors = JSON.parse(data);
      });

      $('#email-feedback').html(errors.join('<br>'));

      return errors.length === 0;
    }

    function validatePassword() {
      let password = $('#password-input').val();

      let errors = [];
      if (password.length === 0) {
        errors.push('パスワードを入力してください');
      }
      if (password.length < 8) {
        errors.push('8文字以上で入力してください');
      }
      if (!/[a-zA-Z]/.test(password)) {
        errors.push('アルファベットが含まれていません');
      }
      if (!/\d/.test(password)) {
        errors.push('数字が含まれていません');
      }
      $('#password-feedback').html(errors.join('<br>'));

      return errors.length === 0;
    }

    function validatePasswordCheck() {
      let password = $('#password-input').val();
      let passwordCheck = $('#password-check-input').val();

      let errors = [];
      if (password !== passwordCheck) {
        errors.push('パスワードが一致しません')
      }
      $('#password-check-feedback').html(errors.join('<br>'));

      return errors.length === 0;
    }

    $('#name-input')[0].addEventListener('input', validateName);
    $('#email-input')[0].addEventListener('input', validateEmail);
    $('#password-input')[0].addEventListener('input', validatePassword);
    $('#password-check-input')[0].addEventListener('input', validatePasswordCheck);

    $('#registration-form')[0].addEventListener('submit', event => {
      if (!(validateName() & validateEmail() & validatePassword() & validatePasswordCheck())) {
        event.preventDefault();
        event.stopPropagation();
      }
    });
  </script>
{% include 'post_body.html.twig' %}
